service: yes

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs14.x
  iamRoleStatements:
    - Effect: Allow # / Deny
      Action:
        - s3:*
        - dynamodb:*
        - cognito-idp:*
        - cognito-identity:*
        - cloudsearch:*
        - ssm:GetParameter
        - cognito-idp:AdminCreateUser
      Resource:
        - '*'
  environment:
    DYNAMODB_USER_TABLE: ${self:service}-usertable-${sls:stage}

custom:
  userPoolName: test-user-pool-${sls:stage}
  userPoolClientName: test-user-pool-client-${sls:stage}


resources:
  Resources:
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        MfaConfiguration: OFF
        UserPoolName: ${self:custom.userPoolName}
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 6
            RequireLowercase: False
            RequireNumbers: True
            RequireSymbols: False
            RequireUppercase: True
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:custom.userPoolClientName}
        GenerateSecret: False
        UserPoolId:
          Ref: CognitoUserPool
      #
    UserTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-usertable-${sls:stage}
        AttributeDefinitions:
          - AttributeName: name
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: name
            KeyType: HASH
          - AttributeName: email
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: Email-index
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST

functions:
  getUser:
    handler: getUser.getUser
    events:
      - http:
          path: /users/{name}
          method: get
          request:
            parameters:
              paths:
                name: true
          cors:
            origin: '*'
            headers:
              - '*'
  getUsers:
    handler: getUsers.getUsers
    events:
      - http:
          path: /users
          method: get
          cors:
            origin: '*'
            headers:
              - '*'
  createUsers:
    handler: createUser.createUsers
    environment:
      COGNITO_USER_POOL_ID: Ref !CognitoUserPool
    events:
      - http:
          path: /users
          method: post
#      - cognitoUserPool:
#          pool: ${self:provider.stage}MyUserPool
  getFromGSI:
    handler: getFromGSI.getFromGSI
    events:
      - http:
          path: /
          method: get
          request:
            parameters:
              paths:
                name: true
          cors:
            origin: '*'
            headers:
              - '*'
